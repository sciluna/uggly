!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).TraceSkeleton=r()}(this,(function(){"use strict";return new function(){var t=this;function r(t,r,e,n){for(var o=0,a=1;a<e-1;a++)for(var i=1;i<r-1;i++){var f=1&t[(a-1)*r+i],h=1&t[(a-1)*r+i+1],l=1&t[a*r+i+1],u=1&t[(a+1)*r+i+1],c=1&t[(a+1)*r+i],s=1&t[(a+1)*r+i-1],v=1&t[a*r+i-1],g=1&t[(a-1)*r+i-1],d=f+h+l+u+c+s+v+g;1==(0==f&&1==h)+(0==h&&1==l)+(0==l&&1==u)+(0==u&&1==c)+(0==c&&1==s)+(0==s&&1==v)+(0==v&&1==g)+(0==g&&1==f)&&d>=2&&d<=6&&0==(0==n?f*l*c:f*l*v)&&0==(0==n?l*c*v:f*c*v)&&(t[a*r+i]|=2)}for(a=0;a<e*r;a++){var p=t[a]>>1,M=1&t[a];t[a]=M&!p,o||t[a]==M||(o=1)}return o}function e(t,r,e,n,o,a,i){for(var f=o;f<o+i;f++)for(var h=n;h<n+a;h++)if(t[f*r+h])return!0;return!1}function n(t,r,e,n,o,a){var i=(a>>1&1)>0,f=(a>>0&1)>0,h=-1,l=4,u=r[e].length-1,c=r[e][f?0:u];if(Math.abs(c[o?1:0]-n)>0)return!1;for(var s=0;s<t.length;s++){var v=t[s].length-1,g=t[s][i?0:v];if(!(Math.abs(g[o?1:0]-n)>1)){var d=Math.abs(g[o?0:1]-c[o?0:1]);d<l&&(h=s,l=d)}}return-1!=h&&(i&&f?(r[e].reverse(),t[h]=r[e].concat(t[h])):!i&&f?t[h]=t[h].concat(r[e]):i&&!f?t[h]=r[e].concat(t[h]):(r[e].reverse(),t[h]=t[h].concat(r[e])),r.splice(e,1),!0)}t.thinningZS=function(t,e,n){var o=!0;do{o&=r(t,e,n,0),o&=r(t,e,n,1)}while(o)};function o(t,r,e,o){for(var a=r.length-1;a>=0;a--)if(1==o){if(n(t,r,a,e,!1,1))continue;if(n(t,r,a,e,!1,3))continue;if(n(t,r,a,e,!1,0))continue;if(n(t,r,a,e,!1,2))continue}else{if(n(t,r,a,e,!0,1))continue;if(n(t,r,a,e,!0,3))continue;if(n(t,r,a,e,!0,0))continue;if(n(t,r,a,e,!0,2))continue}r.map(r=>t.push(r))}function a(t,r,e,n,o,a,i){for(var f=[],h=!1,l=-1,u=-1,c=0;c<i+i+a+a-4;c++){c<a?(d=o+0,p=n+c):c<a+i-1?(d=o+c-a+1,p=n+a-1):c<a+i+a-2?(d=o+i-1,p=n+a-(c-a-i+3)):(d=o+i-(c-a-i-a+4),p=n+0),t[d*r+p]?h||(h=!0,f.push([[p,d],[Math.floor(n+a/2),Math.floor(o+i/2)]])):h&&(f[f.length-1][0][0]=Math.floor((f[f.length-1][0][0]+u)/2),f[f.length-1][0][1]=Math.floor((f[f.length-1][0][1]+l)/2),h=!1),l=d,u=p}if(2==f.length)f=[[f[0][0],f[1][0]]];else if(f.length>2){for(var s=0,v=-1,g=-1,d=o+1;d<o+i-1;d++)for(var p=n+1;p<n+a-1;p++){var M=t[d*r-r+p-1]+t[d*r-r+p]+t[d*r-r+p-1+1]+t[d*r+p-1]+t[d*r+p]+t[d*r+p+1]+t[d*r+r+p-1]+t[d*r+r+p]+t[d*r+r+p+1];(M>s||M==s&&Math.abs(p-(n+a/2))+Math.abs(d-(o+i/2))<Math.abs(g-(n+a/2))+Math.abs(v-(o+i/2)))&&(v=d,g=p,s=M)}if(-1!=v)for(d=0;d<f.length;d++)f[d][1]=[g,v]}return f}t.traceSkeleton=function(r,n,i,f,h,l,u,c,s,v){var g=[];if(0==s)return g;if(l<=c&&u<=c)return a(r,n,0,f,h,l,u);var d=n+i,p=-1,M=-1;if(u>c)for(var m=h+3;m<h+u-3;m++)if(!(r[m*n+f]||r[(m-1)*n+f]||r[m*n+f+l-1]||r[(m-1)*n+f+l-1])){for(var k=0,w=f;w<f+l;w++)k+=r[m*n+w],k+=r[(m-1)*n+w];(k<d||k==d&&Math.abs(m-(h+u/2))<Math.abs(p-(h+u/2)))&&(d=k,p=m)}if(l>c)for(w=f+3;w<f+l-3;w++)if(!(r[n*h+w]||r[n*(h+u)-n+w]||r[n*h+w-1]||r[n*(h+u)-n+w-1])){for(k=0,m=h;m<h+u;m++)k+=r[m*n+w],k+=r[m*n+w-1];(k<d||k==d&&Math.abs(w-(f+l/2))<Math.abs(M-(f+l/2)))&&(d=k,p=-1,M=w)}if(u>c&&-1!=p){var b=[f,p,l,h+u-p];e(r,n,0,($=[f,h,l,p-h])[0],$[1],$[2],$[3])&&(null!=v&&v.push($),g=t.traceSkeleton(r,n,i,$[0],$[1],$[2],$[3],c,s-1,v)),e(r,n,0,b[0],b[1],b[2],b[3])&&(null!=v&&v.push(b),o(g,t.traceSkeleton(r,n,i,b[0],b[1],b[2],b[3],c,s-1,v),p,2))}else if(l>c&&-1!=M){var $;b=[M,h,f+l-M,u];e(r,n,0,($=[f,h,M-f,u])[0],$[1],$[2],$[3])&&(null!=v&&v.push($),g=t.traceSkeleton(r,n,i,$[0],$[1],$[2],$[3],c,s-1,v)),e(r,n,0,b[0],b[1],b[2],b[3])&&(null!=v&&v.push(b),o(g,t.traceSkeleton(r,n,i,b[0],b[1],b[2],b[3],c,s-1,v),M,1))}return-1==p&&-1==M&&(g=a(r,n,0,f,h,l,u)),g},t.trace=function(r,e,n,o){t.thinningZS(r,e,n);var a=[];return{rects:a,polylines:t.traceSkeleton(r,e,n,0,0,e,n,o,999,a),width:e,height:n}},t.onload=function(t){t()},t.fromBoolArray=function(r,e,n){return t.trace(r.map(t=>t?1:0),e,n,10)},t.fromCharString=function(r,e,n){return t.trace(r.split("").map(t=>t.charCodeAt(0)),e,n,10)},t.fromImageData=function(r){for(var e=r.width,n=r.height,o=r.data,a=[],i=0;i<o.length;i+=4)o[i]?a.push(1):a.push(0);return t.trace(a,e,n,10)},t.fromCanvas=function(r){var e=r.getContext("2d").getImageData(0,0,r.width,r.height);return t.fromImageData(e)},t.visualize=function(t,r){var e=t.rects,n=t.polylines;null==r&&(r={});var o=null==r.scale?1:r.scale,a=null==r.strokeWidth?1:r.strokeWidth,i=null==r.rects?1:0,f=r.keypoints=1,h=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="${t.width*o}" height="${t.height*o}">`;if(i)for(var l=0;l<e.length;l++)h+=`<rect fill="none" stroke="gray" x="${e[l][0]*o}" y="${e[l][1]*o}" width="${e[l][2]*o}" height="${e[l][3]*o}" />`;for(l=0;l<n.length;l++)h+=`<path fill="none" stroke-width="${a}" stroke="rgb(${Math.floor(200*Math.random())},${Math.floor(200*Math.random())},${Math.floor(200*Math.random())})" d="M${n[l].map(t=>t[0]*o+","+t[1]*o).join(" L")}"/>`;if(f)for(l=0;l<n.length;l++)for(var u=0;u<n[l].length;u++)h+=`<rect fill="none" stroke="red" x="${n[l][u][0]*o-1}" y="${n[l][u][1]*o-1}" width="2" height="2"/>`;return h+="</svg>"}}}));
